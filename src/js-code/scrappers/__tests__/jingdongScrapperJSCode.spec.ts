import { TextEncoder, TextDecoder } from 'util';

// https://github.com/jsdom/jsdom/issues/2524 이슈 해결법
Object.defineProperty(window, 'TextEncoder', {
  writable: true,
  value: TextEncoder,
});
Object.defineProperty(window, 'TextDecoder', {
  writable: true,
  value: TextDecoder,
});

import { JSDOM } from 'jsdom';
import jsCode from '../jingdongScrapperJSCode';

const html = `
<html>
  <body>
    <div class="search_prolist cols_1" id="itemList">
      <div class="search_prolist_item active" skuid="10049808384898" order="1"><div class="search_prolist_item_inner J_ping" id="link_10049808384898" rd="0-4-4" ind="1" page="1" usedsplx="undefined" ad="1" vid="786896" sid="782694" dsale_status="undefined" pos="1" click_url="https://ccc-x.jd.com/dsp/nc?ext=aHR0cDovL2l0ZW0ubS5qZC5jb20vcHJvZHVjdC8xMDA0OTgwODM4NDg5OC5odG1s&amp;log=vdTNl5MXU6o3mYO_m0PzewxkZ0hqQF43yfaFU04UjsmzAF6E5Njq56sbiavLHZE3T89yJ4apv8CJU8rZAT_nPlmjnOuv4TsgMjPHo0n1c2l8uc8ApJ1TEnYsjv2l1Z-bS9TiQhcctqOQWfMnC_4fQSjAwD7kSOTDTOgu85EOU9OWMgJY_GvsC2hQfmyaxhgKJD1xJ6tIpXIdIFQoKKFYeHA5Jy8pL_N7cqcaTu3635PJWLg72eubQK6t9oxwdhccohzekIvITHZYDZIEscXla_1zyNk7CtI3bcpqHqa1KNW5jDqOeE-miOMd_EqHA1JZ97Vb7SClI7VUON850x8V6pXLHUXsAxzRdMZT_AGsa_M52CcoQcEKVdombcq2GherJX_rOgRhDbehWMMgGJPLfdD8tHCeVQWGfabZjcvMIQIHDRP8irEDjrNJu8rp2NffS8DO4B-Y6obQr_ABjiTXpvoG8zV7ZNYsEQBUHE07CgpMePVZzN_TtZsNiHn059mBOWAa4bodpMWI6a5GuImyvPqUf9Wp0ZLZL3qyVHPrtMq4A2DgCz0Wy8Qmpap4z1We3YgAG-FElfsuuErVpdwdljmMOi3bjNTE4e6lCN6wfXLk8eiwHX1uCHFQlQAhE8DuDtf-pL8h44YvuEJP9VlmsVomI12jrT07aOeBVtCoeOMgKUhYtSnPlt--FLVK_Ex8K7jY5ekOlIPniHn1csImFQI27SMVZw9Rawn9YUCqJDEBlejyhRCwkHwmrD1XJbBjo1dj7usTeCpMJgNc8DLecF-j5ZMe9i7Jt1QG_8ew6RGIl1ovf4XaQwhlHah4O9wFCK59GhhfBK5epIb38-PRVddF3uYPkgSi5oXu_B9Q1nN-5hAI2017kN66YbWbvNYMm3cTrM-hC_WmQaZm6ncKwyeM7UVwwGuSxPRJ4I-rtdRbN90FEvu1tUmXpr1XLZslJJ6AGjUd30Bz_7omVJDw8Dr9O70BqjqLaGnMi7iurtBm0mkcNWoc_XAQzoxdZ5r8lK6rlTnCpespkYFc9PWWjiEACczwQALyPlk7tDm8YXUqk3jbx9LTYtAn0bBQUL2s3NoUP3AZEVENQg4htHQoH0KjUGEojHll6FWqHX7DaARdYlbLeTBLD7oFQwvhX6o4n4ZFVUVCoY8Y2wYR_V2GOO1QvnO5a7Q2X8KHPi3fNk7kNn25i9tYIPR2cePJVu7z-tVZseuveHTVgZYlXyemWxMH2ArcmBBSP8U_bj6RKqXlyfpUrhlEUH-wsWOuc2cojPrKMY7yozEOGZoeUvf6_bZ-V0SFyI_xq4UEABxuZJAZq9iEShUFOsnUpcaLRBwt7rFqsM4fxTUd1LfFcQgGzj5cUBr6veyrgyv5O4GFWscJkdmsEbnPZDiN8IKNxgJYHJOLqiGFfyLhHjgl5OPKaokC7msRNtAQZRz-_GIssn0zFH7AOYLzx3j0ydd-d67whxKs4QBugyI1TB5YYQuCQ7RRZgsDHyFx11puUBtQaAKBAseBchVCFkUV5iquhNMlZPNQgVDqS9D_bPAOntK4CHAP9Nwn8WVcYLvkdvm-MI4mbKyY1V9qjJOTDPEMxBoix1NNaCwRh207cd0C2MbzH-xPI5l-b_r7wKAlpVqSjzXT70TUtMrOLF80OI_Av01XMP9hsUcRCscqZyXZGx3uAkUwkFxIcIwPkF9jVps6uFqk9QwRH9F97mgadvDuKW7vP0WnkiigsNaw7KwFxsF0HY6zu1Zj3kptpF4obLP5JSHTj3ivLsNrMpfWiyx08S4hQdaqbEAkwk1AZiGdoK4E8heD9d5XFti9X4_vKGp8GfCE_BmjfKbRdcAb28ODGxFM-nbByeXGlUfTVF1m4kA_4hpF0PkDYTiRPnhKHyUoBDS0R3pt3a8voRMnhesqNv9NUMq3lymjLyHlPGBFIipid6ME7qBRlQ853EA5fE1cxLBRWpDuo9mkpAHE3FrzJXP2sZbOPSRNVeMkek3yOJr90WVuVefn0NlVDZjvimBTi_PmTWSXo8i-IresYk9vxuvrhqD0FoZlPBD_SaMf0qwiGGsrwYqK7olFqumfSV9yV0feoFo1M4Lihds6XtZ3xgU8qXBu6oGJWXIAcvilCCnPMs4mBVJjAnhkitvrHxCIIP0d9eQl2wbjpIabdTfAMgrCzbbjesyNl6YylMunah0b-TqHsfIxaEXp4eabwiN1AFEMLLpxPXo6VhEjfZ61z2yu-HN-4tGDL4PhVEnESTJJrBQZV8Y5lv8tXaD970pmXO3ji_wD1lHgYXFZ_QllDlMFSeHx92Uk1-zN4osvIH2liz5_VaAPXpgmsXAlOeW080K8c7b0ULcTGxDh_vI-Car4x_0Oni96GBu2D094FNdYaHQnJS2H43yttUElnW3ZmRWyPilfK-98Rneuz6wORBRN8Kr5tvmbvcPVk-_deh7UHKIMup9Jl4rI_GgFf__mmDq2wJ1fsmn5VKmoE5FSyUUuAp653yIKCDgQf1tciF867R8G_JazwVdwteouEAekmr84TeVpXRhIaD6xwQs3pJ89zLVCFE0WbzS242DMWMozePn5cS7SW108ERwbrQsqrDUSCxXWwySRmEygyuSawBk3pyTXSXcaB0k1suUU9GapKA&amp;v=404" click_url_redirected="1" pure_item_link="https://item.m.jd.com/product/10049808384898.html?_fd=jdm" tourl="https://item.m.jd.com/product/10049808384898.html?_fd=jdm&amp;price=499.00&amp;fs=1" shopurl="https://shop.m.jd.com/shopv2/mzpage?venderId=786896&amp;_fd=jdm" ifad="0" ver="0" eventid="0" csid="81f941a46481d61d9e1b4e23dc64cd18_1667538068494_1_1667538068494" ss_projid="undefined" ss_expid="undefined" ss_ruleid="undefined" ss_sexpid="undefined" ss_sruleid="undefined" extension_id="%7B%22ad%22%3A%221223%22%2C%22ch%22%3A%222%22%2C%22sku%22%3A%2210049808384898%22%2C%22ts%22%3A%221667538068%22%2C%22uniqid%22%3A%22%7B%5C%22material_id%5C%22%3A%5C%227496682430%5C%22%2C%5C%22pos_id%5C%22%3A%5C%221223%5C%22%2C%5C%22sid%5C%22%3A%5C%22dbfc1615-ec31-404e-9a86-8368864d3dbd%5C%22%7D%22%7D" symbol="2" report-eventid="MList_Product" report-eventlevel="4" report-eventparam="1____10049808384898_nike__0_0_0_1_____2_0_0_##_nike_7_AD10049808384898_1664367286677286868148_0_0_0_0_0_0_0_0_0_0_0_1_1318;11729;_12099;11730;_9754;9757;9756;6908;12100;_0__0"> <div class="search_prolist_cover" rd="0-4-4"> <img class="photo" init_src="jfs/t1/145582/32/30991/61136/6364490dEc366fc59/0e05bf0178d5fdb9.jpg" alt="" inited="1" skuid="10049808384898" rd="0-4-4" lpmark="0" onerror="__reloadResource(this)" src="https://img13.360buyimg.com/n2/s270x270_jfs/t1/145582/32/30991/61136/6364490dEc366fc59/0e05bf0178d5fdb9.jpg!q70.webp">   </div> <div class="search_prolist_info flex"> <div id="pro_info_above_10049808384898"> <div class="search_prolist_title" data-line="2" data-line-img="2" rd="0-4-4"><i class="mod_tag"><img src="https://m.360buyimg.com/umm/jfs/t1/105372/25/27109/1799/6347a823E3c59c6b2/e2b50edc8e156776.png"></i>   JORDAN LEGACY 312 LOW (PS) 运动鞋 CD9055-116 31  </div>    </div> <div id="pro_info_below_10049808384898"> <div class="search_prolist_price" rd="0-4-4" id="price_10049808384898"> <strong rd="0-4-4"> <em id="dp_J_10049808384898" rd="0-4-4" pri="499.00">¥ <span class="int">499</span></em> </strong> </div> <div class="search_prolist_line" id="nprice_10049808384898" can-fill="1"></div> <div class="search_prolist_other text_small" rd="0-4-4" id="comtag_10049808384898"> <span class="search_prolist_comment"><span id="com_10049808384898">200+</span>条评价</span> <span class="search_prolist_rate">好评率<span id="rate_10049808384898">96</span>%</span> </div> <div class="search_prolist_shop with_padding" rd="0-4-41"> <div id="shoptag_10049808384898"></div> <div class="shop_area"><span class="shop_name">TOPSPORTS官方旗舰店</span></div> </div> <div class="search_prolist_other text_small hide" rd="0-4-4" id="bomtag_10049808384898"></div> <div class="search_prolist_ad">广告</div> </div> </div></div></div>
      <div class="search_prolist_item" skuid="10052465144305" cid="1318~12099~9768"> <div class="search_prolist_item_inner J_ping" id="link_10052465144305" lb="0" ind="2" page="1" usedsplx="0" rd="0-4-1" vid="10084133" dsale_status="0" isdsalerecm="" sid="925804" pos="2" pure_item_link="https://item.m.jd.com/product/10052465144305.html?_fd=jdm" tourl="https://item.m.jd.com/product/10052465144305.html?_fd=jdm&amp;price=289.00&amp;fs=1" shopurl="https://shop.m.jd.com/shopv2/mzpage?venderId=10084133&amp;_fd=jdm" ifad="0" ver="0" eventid="0" csid="81f941a46481d61d9e1b4e23dc64cd18_1667538068494_1_1667538068494" pps="undefined" ss_projid="undefined" ss_expid="undefined" ss_ruleid="undefined" ss_sexpid="undefined" ss_sruleid="undefined" symbol="10" report-eventid="MList_Product" report-eventlevel="4" report-eventparam="1_1318_12099_9768_10052465144305_nike__1_0_0_1_____2_0_0_##_nike_7_NA10052465144305_1664367286677286868148_0_0_0_0_0_0_0_0_0_0_0_2_1318;11729;_12099;11730;_9754;9757;9756;6908;12100;_0__0"> <div class="search_prolist_cover" rd="0-4-1"> <img class="photo" init_src="jfs/t1/173379/2/31521/71774/6363e531Ed9b4fbc9/c021f8028a1a9787.jpg" alt="" inited="1" skuid="10052465144305" rd="0-4-1" lpmark="0" onerror="__reloadResource(this)" src="https://img10.360buyimg.com/n2/s270x270_jfs/t1/173379/2/31521/71774/6363e531Ed9b4fbc9/c021f8028a1a9787.jpg!q70.webp"> </div> <div class="search_prolist_info flex" rd="0-4-1"> <div id="pro_info_above_10052465144305"> <div class="search_prolist_title" data-line="2" data-line-img="2" rd="0-4-1"><i class="mod_tag"><img src="https://m.360buyimg.com/umm/jfs/t1/105372/25/27109/1799/6347a823E3c59c6b2/e2b50edc8e156776.png"></i><i class="mod_tag"><img src="//img11.360buyimg.com/jdphoto/s88x28_jfs/t1/65879/31/15544/1984/5dd25aeaEe17e2044/1c476a98287a9956.png"></i>  Nike耐克 男包女包运动包休闲单肩大容量斜挎包BA5751-072 BA5751-072  </div>       <div class="search_prolist_attr" rd="0-4-1">   <span class="word">涤纶(聚酯纤维)</span>    <span class="word">拉链</span>   </div>    </div> <div id="pro_info_below_10052465144305"> <div class="search_prolist_price" rd="0-4-1" id="price_10052465144305"> <strong rd="0-4-1">  <em id="dp_J_10052465144305" rd="0-4-1" pri="289.00">¥ <span class="int">289</span></em>  </strong> </div> <div class="search_prolist_line" rd="0-4-1" id="nprice_10052465144305" pro="1" can-fill="1">  <span class="search_prolist_coupon">领券满99减10</span><i class="mod_sign_tip bor coupon_sale_mark"><span>满200减30</span></i></div> <div class="search_prolist_other text_small" rd="0-4-1" id="comtag_10052465144305"> <span class="search_prolist_comment" rd="0-4-1"><span id="com_10052465144305">68</span>条评价</span> <span class="search_prolist_rate" rd="0-4-1">好评率<span id="rate_10052465144305">100</span>%</span> </div> <div class="search_prolist_shop" rd="0-4-41"> <div id="shoptag_10052465144305"></div> <div class="shop_area"><span class="shop_name">T1海外专营店</span></div> </div>  <div class="search_prolist_other text_small hide" rd="0-4-1" id="bomtag_10052465144305"></div>  </div> </div> </div> </div>
      <div class="search_interlude" after="4"><div class="J_ping J_ping" id="mDownload" style="background-color: rgb(255, 255, 255); display: block;" report-eventid="MDownLoadFloat_OpenNow">\n                        <img src="//m.360buyimg.com/mobilecms/jfs/t17851/344/2460261989/63175/d5d66db/5af926a5Nb439e68a.jpg" style="width:100%;"></div></div>
      <div class="search_prolist_item" skuid="100039047053" cid="1318~12099~12100"> <div class="search_prolist_item_inner J_ping" id="link_100039047053" lb="0" ind="5" page="1" usedsplx="0" rd="0-4-1" vid="1000001927" dsale_status="0" isdsalerecm="" sid="1000001927" pos="5" pure_item_link="https://item.m.jd.com/product/100039047053.html?_fd=jdm" tourl="https://item.m.jd.com/product/100039047053.html?_fd=jdm&amp;price=509.00&amp;fs=1" shopurl="https://shop.m.jd.com/shopv2/mzpage?venderId=1000001927&amp;_fd=jdm" ifad="0" ver="0" eventid="0" csid="81f941a46481d61d9e1b4e23dc64cd18_1667538068494_1_1667538068494" pps="undefined" ss_projid="undefined" ss_expid="undefined" ss_ruleid="undefined" ss_sexpid="undefined" ss_sruleid="undefined" symbol="8" report-eventid="MList_Product" report-eventlevel="4" report-eventparam="1_1318_12099_12100_100039047053_nike__0_1_0_1_____2_0_0_##_nike_7_NA100039047053_1664367286677286868148_0_0_0_0_0_0_0_0_0_0_0_5_1318;11729;_12099;11730;_9754;9757;9756;6908;12100;_0__0"> <div class="search_prolist_cover" rd="0-4-1"> <img class="photo" init_src="jfs/t1/159372/21/30380/60948/6323f330E2a7d6c0f/b615e1a3da440039.jpg" alt="" inited="1" skuid="100039047053" rd="0-4-1" lpmark="0" onerror="__reloadResource(this)" src="https://img13.360buyimg.com/n2/s270x270_jfs/t1/159372/21/30380/60948/6323f330E2a7d6c0f/b615e1a3da440039.jpg!q70.webp"> </div> <div class="search_prolist_info flex" rd="0-4-1"> <div id="pro_info_above_100039047053"> <div class="search_prolist_title" data-line="2" data-line-img="2" rd="0-4-1">  耐克NIKE 男子 运动板鞋 经典 百搭 COURT VISION MID NEXT NATURE 运动鞋 DN3577-600深甜菜根色色42码  </div>       <div class="search_prolist_attr" rd="0-4-1">   <span class="word">2020年冬季</span>    <span class="word">中帮</span>    <span class="word">系带</span>   </div>    </div> <div id="pro_info_below_100039047053"> <div class="search_prolist_price" rd="0-4-1" id="price_100039047053"> <strong rd="0-4-1">  <em id="dp_J_100039047053" rd="0-4-1" pri="509.00">¥ <span class="int">509</span></em>  </strong> </div> <div class="search_prolist_line" rd="0-4-1" id="nprice_100039047053" can-fill="1">  <span class="search_prolist_coupon">领券满2000减120</span></div> <div class="search_prolist_other text_small" rd="0-4-1" id="comtag_100039047053"><i class="mod_tag" rd="0-4-1"><img src="//img11.360buyimg.com/jdphoto/s48x28_jfs/t1/12264/37/1979/1085/5c185d6dEba7743da/c5ab4d78f8bf4d90.png"></i><i class="mod_tag" rd="0-4-1"><img src="//img11.360buyimg.com/jdphoto/s68x28_jfs/t28474/79/699858248/2214/bced3f94/5bfb58faNfdbaaf9e.png"></i> <span class="search_prolist_comment" rd="0-4-1"><span id="com_100039047053">2万+</span>条评价</span> <span class="search_prolist_rate" rd="0-4-1">好评率<span id="rate_100039047053">90</span>%</span> </div> <div class="search_prolist_shop" rd="0-4-41"> <div id="shoptag_100039047053"></div> <div class="shop_area"><span class="shop_name">耐克（NIKE）京东自营专区</span></div> </div>  <div class="search_prolist_other text_small hide" rd="0-4-1" id="bomtag_100039047053"></div>  </div> </div> </div> </div>
    </div>
  </body>
</html>
`;

describe('jingdongScrapperJSCode', () => {
  test('검색 결과 추출', () => {
    const instruction = jsCode;

    const { document } = new JSDOM(html).window;

    Object.defineProperty(window, 'document', {
      writable: true,
      value: document,
    });

    const scrap = new Function(instruction);

    const result = scrap();

    expect(result[0].title).toBe('JORDAN LEGACY 312 LOW (PS) 运动鞋 CD9055-116 31');
    expect(result[0].image).toBe('https://img13.360buyimg.com/n2/s270x270_jfs/t1/145582/32/30991/61136/6364490dEc366fc59/0e05bf0178d5fdb9.jpg!q70.webp');
    expect(result[0].href).toBe('https://item.m.jd.com/product/10049808384898.html');
    expect(result[0].price).toBe('499');
    expect(result[0].symbol).toBe('¥');

    expect(result[1].title).toBe(`Nike耐克 男包女包运动包休闲单肩大容量斜挎包BA5751-072 BA5751-072`);
    expect(result[1].image).toBe('https://img10.360buyimg.com/n2/s270x270_jfs/t1/173379/2/31521/71774/6363e531Ed9b4fbc9/c021f8028a1a9787.jpg!q70.webp');
    expect(result[1].href).toBe('https://item.m.jd.com/product/10052465144305.html');
    expect(result[1].price).toBe('289');
    expect(result[1].symbol).toBe('¥');

    expect(result[2].title).toBe('耐克NIKE 男子 运动板鞋 经典 百搭 COURT VISION MID NEXT NATURE 运动鞋 DN3577-600深甜菜根色色42码');
    expect(result[2].image).toBe('https://img13.360buyimg.com/n2/s270x270_jfs/t1/159372/21/30380/60948/6323f330E2a7d6c0f/b615e1a3da440039.jpg!q70.webp');
    expect(result[2].href).toBe('https://item.m.jd.com/product/100039047053.html');
    expect(result[2].price).toBe('509');
    expect(result[2].symbol).toBe('¥');
  });
});
